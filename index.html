<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Mattii - ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏¥‡∏ï‡∏û‡∏£‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏≤‡∏¢</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Kanit', sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    canvas { border: 1px solid #ccc; margin-top: 20px; cursor: crosshair; }
    .section { margin-bottom: 30px; }
    .drawing-tools input, .drawing-tools select, .drawing-tools button { margin-right: 10px; margin-top: 5px; }
    #price { font-size: 20px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<h1>Mattii - ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏¥‡∏ï‡∏û‡∏£‡∏°‡∏î‡∏±‡∏Å‡∏ù‡∏∏‡πà‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏≤‡∏¢</h1>

<form id="carpetForm" class="section">
  <label>‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏ã‡∏°.): <input type="number" id="length" value="40"></label>
  <label>‡∏¢‡∏≤‡∏ß (‡∏ã‡∏°.): <input type="number" id="width" value="120"></label>
  <label>‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: <input type="color" id="bgColor" value="#ffffff"></label>
  <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏û‡∏£‡∏°: <input type="text" id="text" value="‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö"></label>
  <label>‡∏ü‡∏≠‡∏ô‡∏ï‡πå:
    <select id="font">
      <option value="Arial">Arial</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Kanit">Kanit</option>
    </select>
  </label>
  <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: <input type="number" id="fontSize" value="24"></label>
  <label>‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: <input type="color" id="textColor" value="#000000"></label>
  <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: <input type="file" id="imageUpload" accept="image/*"></label>
  <label>‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: <input type="range" id="imageSizeSlider" min="50" max="300" value="100"></label>
</form>

<div class="drawing-tools">
  <label>‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏≠: <input type="range" id="penSize" min="1" max="10" value="3"></label>
  <label>‡∏™‡∏µ‡∏î‡∏¥‡∏ô‡∏™‡∏≠: <input type="color" id="penColor" value="#ff0000"></label>
  <button type="button" id="toggleDrawing">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î</button>
  <button type="button" id="toggleEraser">‡πÄ‡∏õ‡∏¥‡∏î ‡∏¢‡∏≤‡∏á‡∏•‡∏ö</button>
  <button type="button" id="clearDrawing">‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>

<canvas id="previewCanvas" width="800" height="600"></canvas>
<div id="price">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: - ‡∏ö‡∏≤‡∏ó</div>
<button id="downloadPDF">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏£‡∏µ‡∏ü</button>

<script>
  const canvas = document.getElementById('previewCanvas');
  const ctx = canvas.getContext('2d');

  let isDrawingEnabled = false;
  let penMode = 'draw';
  let dragging = null;
  let offsetX = 0, offsetY = 0;
  let isDrawing = false;
  let lastX = 0, lastY = 0;

  const state = {
    text: { content: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', x: 100, y: 100, fontSize: 24, font: 'Arial', color: '#000000' },
    image: { img: null, x: 0, y: 0, width: 100, height: 100 },
    drawing: []
  };

  function updateStateFromForm() {
    state.text.content = document.getElementById('text').value;
    state.text.font = document.getElementById('font').value;
    state.text.fontSize = parseInt(document.getElementById('fontSize').value);
    state.text.color = document.getElementById('textColor').value;
  }

  function redrawCanvas() {
    const bgColor = document.getElementById('bgColor').value;
    const width = parseInt(document.getElementById('width').value);
    const height = parseInt(document.getElementById('length').value);

    canvas.width = width * 4;
    canvas.height = height * 4;

    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = state.text.color;
    ctx.font = `${state.text.fontSize * 4}px ${state.text.font}`;
    ctx.fillText(state.text.content, state.text.x, state.text.y);

    if (state.image.img) {
      ctx.drawImage(state.image.img, state.image.x, state.image.y, state.image.width, state.image.height);
    }

    state.drawing.forEach(line => {
      ctx.beginPath();
      ctx.moveTo(line.startX, line.startY);
      ctx.lineTo(line.endX, line.endY);
      ctx.strokeStyle = line.color;
      ctx.lineWidth = line.size;
      ctx.stroke();
    });

    const area = (width * height) / 10000;
    const price = area * 1996;
    document.getElementById('price').innerText = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${price.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
  }

  document.querySelectorAll('#carpetForm input, #carpetForm select').forEach(el => {
    el.addEventListener('input', () => {
      updateStateFromForm();
      if (el.id === 'imageSizeSlider') {
        if (state.image.img) {
          const size = parseInt(el.value);
          state.image.width = size;
          state.image.height = size;
        }
      }
      redrawCanvas();
    });
  });

  canvas.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;

    ctx.font = `${state.text.fontSize * 4}px ${state.text.font}`;
    const textWidth = ctx.measureText(state.text.content).width;
    const textHeight = state.text.fontSize * 4;

    if (x >= state.text.x && x <= state.text.x + textWidth &&
        y <= state.text.y && y >= state.text.y - textHeight) {
      dragging = 'text';
      offsetX = x - state.text.x;
      offsetY = y - state.text.y;
    } else if (state.image.img && x >= state.image.x && x <= state.image.x + state.image.width &&
               y >= state.image.y && y <= state.image.y + state.image.height) {
      dragging = 'image';
      offsetX = x - state.image.x;
      offsetY = y - state.image.y;
    } else if (isDrawingEnabled) {
      isDrawing = true;
      lastX = x;
      lastY = y;
    }
  });

  canvas.addEventListener('mousemove', e => {
    if (!dragging && !isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;

    if (dragging === 'text') {
      state.text.x = x - offsetX;
      state.text.y = y - offsetY;
    } else if (dragging === 'image') {
      state.image.x = x - offsetX;
      state.image.y = y - offsetY;
    } else if (isDrawing) {
      if (penMode === 'draw') {
        state.drawing.push({
          startX: lastX, startY: lastY, endX: x, endY: y,
          color: document.getElementById('penColor').value,
          size: parseInt(document.getElementById('penSize').value)
        });
      } else if (penMode === 'erase') {
        const radius = 10;
        state.drawing = state.drawing.filter(line => {
          const distStart = Math.hypot(line.startX - x, line.startY - y);
          const distEnd = Math.hypot(line.endX - x, line.endY - y);
          return distStart > radius && distEnd > radius;
        });
      }
      lastX = x;
      lastY = y;
    }

    redrawCanvas();
  });

  canvas.addEventListener('mouseup', () => {
    dragging = null;
    isDrawing = false;
  });

  document.getElementById('imageUpload').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      const img = new Image();
      img.onload = function() {
        state.image.img = img;
        state.image.x = 0;
        state.image.y = 0;
        state.image.width = parseInt(document.getElementById('imageSizeSlider').value);
        state.image.height = state.image.width;
        redrawCanvas();
      };
      img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('downloadPDF').addEventListener('click', () => {
      html2canvas(canvas).then(canvasImage => {
        const imgData = canvasImage.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.setFont('Sarabun', 'normal');
        pdf.setFontSize(18);
        pdf.text("Mattii - ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏¥‡∏ï‡∏û‡∏£‡∏°‡∏î‡∏±‡∏Å‡∏ù‡∏∏‡πà‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏≤‡∏¢", 10, 20);
        pdf.addImage(imgData, 'PNG', 10, 30, 190, 100);

        const width = document.getElementById('width').value;
        const length = document.getElementById('length').value;
        const bgColor = document.getElementById('bgColor').value;
        const text = document.getElementById('text').value;
        const font = document.getElementById('font').value;
        const fontSize = document.getElementById('fontSize').value;
        const textColor = document.getElementById('textColor').value;
        const area = (width * length) / 10000;
        const price = area * 1996;

        pdf.setFontSize(12);
        pdf.text(`‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏£‡∏°: ${length} x ${width} ‡∏ã‡∏°.`, 10, 140);
        pdf.text(`‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ${bgColor}`, 10, 150);
        pdf.text(`‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: "${text}"`, 10, 160);
        pdf.text(`‡∏ü‡∏≠‡∏ô‡∏ï‡πå: ${font}, ‡∏Ç‡∏ô‡∏≤‡∏î: ${fontSize}, ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${textColor}`, 10, 170);
        pdf.setFontSize(14);
        pdf.text(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${price.toFixed(2)} ‡∏ö‡∏≤‡∏ó`, 10, 185);

        pdf.save("Mattii-Carpet-Brief.pdf");
      });
    });

    document.getElementById('clearDrawing').addEventListener('click', () => {
      state.drawing = [];
      redrawCanvas();
    });

    document.getElementById('toggleDraw').addEventListener('click', () => {
      drawingEnabled = !drawingEnabled;
      document.getElementById('toggleDraw').innerText = drawingEnabled ? '‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î';
    });

    document.getElementById('eraser').addEventListener('click', () => {
      usingEraser = !usingEraser;
      document.getElementById('eraser').innerText = usingEraser ? '‡πÉ‡∏ä‡πâ‡∏î‡∏¥‡∏ô‡∏™‡∏≠' : '‡∏¢‡∏≤‡∏á‡∏•‡∏ö';
    });

    updateStateFromForm();
    redrawCanvas();
  </script>
</body>
</html>
